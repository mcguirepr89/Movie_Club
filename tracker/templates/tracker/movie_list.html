{% extends "tracker/base.html" %}
{% load dict_extras %}

{% block title %}Movie List{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center">Movie List</h2>

<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {% for movie in movies %}
        {% with viewing=current_user_viewings|get:movie.id %}
        <div class="bg-white rounded-lg shadow p-5 flex flex-col justify-between">
            <div>
                <h3 class="text-xl font-semibold mb-2 flex items-center justify-between">
                    <a href="{% url 'movie_detail' movie.id %}" class="hover:underline">{{ movie.title }}</a>
                    {% if request.user.is_authenticated %}
                        <span id="icon-{{ movie.id }}" class="ml-2 font-bold">
                            {% if viewing %}✅{% else %}❌{% endif %}
                        </span>
                    {% endif %}
                </h3>

                <p class="text-sm text-gray-600 mb-1"><strong>Year:</strong> {{ movie.year }}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Recommended by:</strong> {% if movie.recommended_by %}{{ movie.recommended_by.first_name }}{% endif %}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Categories:</strong> 
                    {% for c in movie.categories.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </p>

                {% if request.user.is_authenticated %}
                <p class="mt-3" id="seen-section-{{ movie.id }}">
                    {% if viewing %}
                        <span class="font-semibold text-green-700" id="status-{{ movie.id }}">I've seen it!</span>
                        <form class="seen-toggle-form inline" data-movie-id="{{ movie.id }}" method="post" action="{% url 'toggle_seen' movie.id %}">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:underline ml-2" id="btn-{{ movie.id }}">Unmark</button>
                        </form>
                        {% if viewing.rating %} - Your Rating: {{ viewing.rating }}{% endif %}
                        {% if viewing.watched_on %} - You Watched on: {{ viewing.watched_on }}{% endif %}
                        {% if viewing.comment %} - Your Comment: {{ viewing.comment }}{% endif %}
                    {% else %}
                        <span class="font-semibold text-gray-500" id="status-{{ movie.id }}">Unseen</span>
                        <form class="seen-toggle-form inline" data-movie-id="{{ movie.id }}" method="post" action="{% url 'toggle_seen' movie.id %}">
                            {% csrf_token %}
                            <button type="submit" class="text-green-600 hover:underline ml-2" id="btn-{{ movie.id }}">Mark as seen</button>
                        </form>
                    {% endif %}
                </p>
                {% endif %}

                {# Other users' viewings #}
                {% with others=viewing_map|get:movie.id %}
                    {% if others %}
                        <div class="mt-4 pt-2 border-t border-gray-200 text-sm text-gray-700">
                            <strong>Who's seen it:</strong>
                            <ul class="mt-1 space-y-1">
                                {% for v in others %}
                                    <li>
                                        <span class="font-semibold">{{ v.user.get_full_name|default:v.user.username }}:</span>
                                        {% if v.watched_on %}Watched on {{ v.watched_on }}{% endif %}
                                        {% if v.rating %}; Rating: {{ v.rating }}{% endif %}
                                        {% if v.comment %}; Comment: {{ v.comment }}{% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                {% endwith %}

            </div>
        </div>
        {% endwith %}
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const forms = document.querySelectorAll(".seen-toggle-form");
    forms.forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const movieId = form.dataset.movieId;
            const btn = document.getElementById(`btn-${movieId}`);
            const status = document.getElementById(`status-${movieId}`);
            const icon = document.getElementById(`icon-${movieId}`);
            const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

            try {
                const response = await fetch(form.action || `/movies/toggle/${movieId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                });
                const data = await response.json();

                if (data.status === "seen") {
                    status.textContent = "I've seen it!";
                    status.className = "font-semibold text-green-700";
                    btn.textContent = "Unmark";
                    btn.className = "text-red-600 hover:underline ml-2";
                    icon.textContent = "✅";
                } else {
                    status.textContent = "Unseen";
                    status.className = "font-semibold text-gray-500";
                    btn.textContent = "Mark as seen";
                    btn.className = "text-green-600 hover:underline ml-2";
                    icon.textContent = "❌";
                }
            } catch (err) {
                console.error(err);
                alert("Could not update status. Please try again.");
            }
        });
    });
});
</script>

{% endblock %}
