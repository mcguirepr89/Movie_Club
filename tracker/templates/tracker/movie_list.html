{% extends "tracker/base.html" %}
{% load dict_extras %}

{% block title %}Movie List{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center">Movie List</h2>

<div class="flex flex-col lg:flex-row gap-6">

<aside class="lg:w-64">

    <!-- Mobile collapsible filters -->
    <details class="lg:hidden mb-4">
        <summary class="cursor-pointer font-semibold bg-gray-100 p-2 rounded">
            Filters & Sorting
        </summary>
        {% include "tracker/_movie_filters.html" with form_class="movie-filters" %}
    </details>

    <!-- Desktop filters -->
    <div class="hidden lg:block">
        {% include "tracker/_movie_filters.html" with form_class="movie-filters" %}
    </div>

</aside>

<div class="flex-1">
    <!-- Filter Chips -->
    <div id="filter-chips" class="flex flex-wrap gap-2 mb-4"></div>

    <!-- Movie Grid -->
    <div id="movie-grid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% include "tracker/_movie_grid.html" %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const movieGrid = document.getElementById("movie-grid");
    const filterChips = document.getElementById("filter-chips");

    async function updateMovies(url) {
        try {
            const response = await fetch(url, {
                headers: {"X-Requested-With": "XMLHttpRequest"}
            });
            const data = await response.text();
            movieGrid.innerHTML = data;
            updateChips();
            initSeenToggle();
        } catch (err) {
            console.error(err);
            alert("Failed to update movies.");
        }
    }

    function getVisibleForm() {
        // Return the first visible filters form
        return Array.from(document.querySelectorAll(".movie-filters"))
            .find(f => f.offsetParent !== null);
    }

    function updateChips() {
        filterChips.innerHTML = "";
        const filtersForm = getVisibleForm();
        const formData = new FormData(filtersForm);
    
        // Collect multi-value keys (checkboxes)
        const entries = {};
        for (const [key, value] of formData.entries()) {
            if (!entries[key]) entries[key] = [];
            entries[key].push(value);
        }
    
        // Mapping keys & values to readable labels
        const keyLabels = {
            sort: "Sort",
            seen: "Seen",
            categories: "Category",
            director: "Director",
            writer: "Writer",
            starring: "Starring",
            streaming: "Streaming",
            recommended_by: "Recommended by"
        };
    
        const sortLabels = {
            title_asc: "Title (A–Z)",
            title_desc: "Title (Z–A)",
            year_asc: "Year (Oldest)",
            year_desc: "Year (Newest)",
            recent: "Recently added"
        };
    
        const seenLabels = {
            "1": "Seen",
            "0": "Unseen",
            "": "All"
        };
    
        for (const key in entries) {
            const values = entries[key].filter(v => v); // skip empty
            if (values.length === 0) continue;
    
            let labelKey = keyLabels[key] || key;
            let displayValues = [];
    
            if (key === "sort") {
                displayValues = values.map(v => sortLabels[v] || v);
            } else if (key === "seen") {
                displayValues = values.map(v => seenLabels[v] || v);
            } else if (key === "categories") {
                displayValues = values.map(v => {
                    const inputEl = filtersForm.querySelector(`input[name="categories"][value="${v}"]`);
                    return inputEl ? inputEl.nextElementSibling.textContent.trim() : v;
                });
            } else if (key === "streaming") {
                displayValues = values.map(v => {
                    const selectEl = filtersForm.querySelector(`select[name="streaming"] option[value="${v}"]`);
                    return selectEl ? selectEl.textContent : v;
                });
            } else if (key === "recommended_by") {
                displayValues = values.map(v => {
                    const selectEl = filtersForm.querySelector(`select[name="recommended_by"] option[value="${v}"]`);
                    return selectEl ? selectEl.textContent : v;
                });
            } else {
                displayValues = values;
            }
    
            const chip = document.createElement("div");
            chip.className = "bg-blue-100 text-blue-800 px-2 py-1 rounded flex items-center gap-1";
            chip.innerHTML = `<span>${labelKey}: ${displayValues.join(", ")}</span> <button type="button" data-key="${key}">&times;</button>`;
            filterChips.appendChild(chip);
    
            // Remove filter when chip clicked
            chip.querySelector("button").addEventListener("click", () => {
                if (key === "categories") {
                    filtersForm.querySelectorAll(`input[name="categories"]`).forEach(input => input.checked = false);
                } else {
                    filtersForm.querySelector(`[name="${key}"]`).value = "";
                }
                const url = filtersForm.action + "?" + new URLSearchParams(new FormData(filtersForm)).toString();
                updateMovies(url);
                history.replaceState(null, "", url);
            });
        }
    }

    function initSeenToggle() {
        const forms = document.querySelectorAll(".seen-toggle-form");
        forms.forEach(form => {
            form.removeEventListener("submit", submitHandler); // prevent duplicates
            form.addEventListener("submit", submitHandler);
        });

        async function submitHandler(e) {
            e.preventDefault();
            const movieId = this.dataset.movieId;
            const btn = document.getElementById(`btn-${movieId}`);
            const status = document.getElementById(`status-${movieId}`);
            const icon = document.getElementById(`icon-${movieId}`);
            const csrfToken = this.querySelector("[name=csrfmiddlewaretoken]").value;

            try {
                const response = await fetch(this.action, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                });
                const data = await response.json();

                if (data.status === "seen") {
                    status.textContent = "I've seen it!";
                    status.className = "font-semibold text-green-700";
                    btn.textContent = "Unmark";
                    btn.className = "text-red-600 hover:underline ml-2";
                    icon.textContent = "✅";
                } else {
                    status.textContent = "Unseen";
                    status.className = "font-semibold text-gray-500";
                    btn.textContent = "Mark as seen";
                    btn.className = "text-green-600 hover:underline ml-2";
                    icon.textContent = "❌";
                }
            } catch (err) {
                console.error(err);
                alert("Could not update status. Please try again.");
            }
        }
    }

    // --- Attach change listeners to all filter forms ---
    document.querySelectorAll(".movie-filters").forEach(filtersForm => {
        filtersForm.querySelectorAll("input, select").forEach(el => {
            el.addEventListener("change", () => {
                const url = getVisibleForm().action + "?" + new URLSearchParams(new FormData(getVisibleForm())).toString();
                updateMovies(url);
                history.replaceState(null, "", url);
            });
        });
    });

    updateChips();
    initSeenToggle();
});
</script>
{% endblock %}
