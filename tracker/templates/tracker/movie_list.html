{% extends "tracker/base.html" %}
{% load dict_extras %}

{% block title %}Movie List{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center">Movie List</h2>

<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {% for movie in movies %}
        {% with viewing=current_user_viewings|get:movie.id %}
        <div class="bg-white rounded-lg shadow p-5 flex flex-col justify-between">
            <div>
                <h3 class="text-xl font-semibold mb-2 flex items-center justify-between">
                    <a href="{% url 'movie_detail' movie.id %}" class="hover:underline">{{ movie.title }}</a>
                    {% if viewing %}<span class="text-green-600 font-bold">✅</span>{% else %}<span class="text-gray-400 font-bold">❌</span>{% endif %}
                </h3>

                <p class="text-sm text-gray-600 mb-1"><strong>Year:</strong> {{ movie.year }}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Recommended by:</strong> {% if movie.recommended_by %}{{ movie.recommended_by.name }}{% endif %}</p>
                <p class="text-sm text-gray-600 mb-1"><strong>Categories:</strong> 
                    {% for c in movie.categories.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </p>

                <p class="mt-3">
                    {% if viewing %}
                        <span class="font-semibold text-green-700">Seen</span>
                        <form action="{% url 'toggle_seen' movie.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:underline ml-2">Unmark</button>
                        </form>
                        {% if viewing.rating %} - Your Rating: {{ viewing.rating }}{% endif %}
                        {% if viewing.watched_on %} - You Watched on: {{ viewing.watched_on }}{% endif %}
                        {% if viewing.comment %} - Your Comment: {{ viewing.comment }}{% endif %}
                    {% else %}
                        <span class="font-semibold text-gray-500">Unseen</span>
                        <form action="{% url 'toggle_seen' movie.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-green-600 hover:underline ml-2">Mark as seen</button>
                        </form>
                    {% endif %}
                </p>

                {# Other users' viewings #}
                {% with others=viewing_map|get:movie.id %}
                    {% if others %}
                        <div class="mt-4 pt-2 border-t border-gray-200 text-sm text-gray-700">
                            <strong>Other Users' Viewings:</strong>
                            <ul class="mt-1 space-y-1">
                                {% for v in others %}
                                    {% if v.person.id != current_user.id %}
                                        <li>
                                            <span class="font-semibold">{{ v.person.name }}:</span>
                                            {% if v.watched_on %}Watched on {{ v.watched_on }}{% else %}Not marked{% endif %};
                                            {% if v.rating %}Rating: {{ v.rating }}{% endif %};
                                            {% if v.comment %}Comment: {{ v.comment }}{% endif %}
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        {% endwith %}
    {% endfor %}
</div>
{% endblock %}
