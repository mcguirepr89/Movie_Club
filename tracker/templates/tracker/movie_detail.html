{% extends "tracker/base.html" %}

{% block title %}{{ movie.title }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto mt-6">
    {% if movie.poster %}                                                                                                                     
        <div class="mb-3">                                                                                                                    
            <img src="{{ movie.poster.url }}" alt="{{ movie.title }} poster" class="w-full h-auto rounded">                                   
        </div>                                                                                                                                
    {% endif %} 
    <h2 class="text-2xl font-bold mb-4 flex items-center">
        {{ movie.title }}
        {% if current_user_viewing %}
            <span class="text-green-600 font-bold ml-2">✅</span>
        {% else %}
            <span class="text-gray-400 font-bold ml-2">❌</span>
        {% endif %}
    </h2>

    <div class="bg-white rounded-lg shadow p-5 mb-6 space-y-2">
        <p><strong>Year:</strong> {{ movie.year }}</p>
        <p><strong>Description:</strong> {{ movie.description|default:"No description" }}</p>
        <p><strong>Runtime:</strong> {% if movie.runtime_minutes %}{{ movie.runtime_minutes }} min{% else %}N/A{% endif %}</p>
        <p><strong>Categories:</strong> {% for c in movie.categories.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
        <p><strong>Streaming Services:</strong> {% for s in movie.streaming_services.all %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
        <p><strong>Starring:</strong> {{ movie.starring }}</p>
        <p><strong>Director:</strong> {{ movie.director }}</p>
        <p><strong>Writer:</strong> {{ movie.writer }}</p>
        <p><strong>Recommended by:</strong> {% if movie.recommended_by %}{{ movie.recommended_by.username }}{% endif %}</p>
    </div>

    {% if user.is_authenticated %}
    <div class="flex space-x-4 mb-6">
        <a href="{% url 'movie_edit' movie.id %}">
            <button class="bg-blue-600 text-white py-1 px-4 rounded hover:bg-blue-700">Edit Movie Metadata</button>
        </a>
        <a href="{% url 'movie_delete' movie.id %}">
            <button class="bg-red-600 text-white py-1 px-4 rounded hover:bg-red-700">Delete Movie</button>
        </a>
    </div>

    <h3 class="text-xl font-semibold mb-2">Your Viewing</h3>
    <form method="post" enctype="multipart/form-data" class="bg-gray-50 rounded-lg border border-gray-200 p-4 mb-6">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="bg-green-600 text-white py-1 px-4 rounded hover:bg-green-700">
            {% if current_user_viewing %}Update{% else %}Add{% endif %}
        </button>
    </form>
    {% endif %}

    {% if other_viewings %}
    {% if user.is_authenticated %}
    <h3 class="text-xl font-semibold mb-2">Other Users' Viewings</h3>
    {% else %}
    <h3 class="text-xl font-semibold mb-2">Viewings</h3>
    {% endif %}
        <ul class="space-y-2">
            {% for v in other_viewings %}
                <li class="border-b border-gray-200 pb-2">
                    <strong>{{ v.user.username }}:</strong>
                    {% if v.watched_on %}Watched on {{ v.watched_on }}{% else %}Not marked{% endif %};
                    {% if v.rating %}Rating: {{ v.rating }}{% endif %};
                    {% if v.comment %}Comment: {{ v.comment }}{% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-500">No other users have viewed this movie yet.</p>
    {% endif %}

    <a href="{% url 'movie_list' %}" class="text-blue-600 hover:underline mt-4 inline-block">← Back to Movie List</a>
</div>
{% endblock %}
